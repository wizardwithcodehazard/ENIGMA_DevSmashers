{% extends "base.html" %}
{% block content %}
<div class="container my-4">
  <h2 class="text-center mb-4">Goal & Progress Dashboard</h2>

  <!-- GitHub-style Monthly Heatmap -->
  <div class="my-4">
    <h4>Monthly Activity Heatmap</h4>
    <div id="monthlyHeatmap" class="heatmap-container">
      <div class="heatmap-months" id="heatmapMonths"></div>
      <div class="heatmap-grid" id="heatmapGrid"></div>
      <div class="heatmap-legend">
        <span class="legend-label">Less</span>
        <div class="legend-squares">
          <div class="legend-square" data-level="0"></div>
          <div class="legend-square" data-level="1"></div>
          <div class="legend-square" data-level="2"></div>
          <div class="legend-square" data-level="3"></div>
          <div class="legend-square" data-level="4"></div>
        </div>
        <span class="legend-label">More</span>
      </div>
    </div>
    <p class="mt-3">
      <strong>Current Streak:</strong> <span id="currentStreak">0</span> days |
      <strong>Max Streak:</strong> <span id="maxStreak">0</span> days |
      <strong>This Month:</strong> <span id="monthlyCount">0</span> active days
    </p>
  </div>

  <!-- Health Metrics Charts -->
  <div class="charts-grid">
    <div class="chart-container">
      <canvas id="bpChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="sleepChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="exerciseChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="stressChart"></canvas>
    </div>
  </div>

  <!-- AI Health Insights -->
  <div class="card p-4 mt-4 shadow-sm">
    <h4 class="mb-3">
      <i class="fas fa-brain text-primary me-2"></i>
      Weekly Health Insights
    </h4>
    <div id="aiSummary" class="ai-summary-content">
      <div class="loading-spinner">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        Analyzing your health data...
      </div>
    </div>
    <!-- Debug information (remove in production) -->
    <div id="debugInfo" class="mt-3" style="display: none;">
      <small class="text-muted">
        <strong>Debug Info:</strong>
        <div id="debugContent"></div>
      </small>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const summaryEl = document.getElementById("aiSummary");
  const debugEl = document.getElementById("debugInfo");
  const debugContent = document.getElementById("debugContent");
  
  // Enable debug mode by adding ?debug=1 to URL
  const urlParams = new URLSearchParams(window.location.search);
  const debugMode = urlParams.get('debug') === '1';
  
  if (debugMode) {
    debugEl.style.display = 'block';
  }
  
  function logDebug(message, data = null) {
    if (debugMode) {
      console.log(message, data);
      const debugMsg = document.createElement('div');
      debugMsg.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
      if (data) {
        debugMsg.innerHTML += `<br><pre style="font-size: 11px;">${JSON.stringify(data, null, 2)}</pre>`;
      }
      debugContent.appendChild(debugMsg);
    }
  }
  
  function showAIError(message, isRetryable = false) {
    let errorHtml = `
      <div class="alert alert-warning border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-exclamation-triangle me-3 text-warning" style="font-size: 1.2em;"></i>
          <div class="flex-grow-1">
            <strong>AI Analysis Unavailable</strong>
            <div class="mt-1 text-muted">${message}</div>
          </div>`;
    
    if (isRetryable) {
      errorHtml += `
          <button class="btn btn-sm btn-outline-primary ms-2" onclick="retryAIAnalysis()">
            <i class="fas fa-refresh me-1"></i>Retry
          </button>`;
    }
    
    errorHtml += `
        </div>
      </div>`;
    
    summaryEl.innerHTML = errorHtml;
  }
  
  function showAISummary(aiData) {
    logDebug("Processing AI summary data", aiData);
    
    let summaryHtml = '';
    
    // Handle different response formats
    if (typeof aiData === 'string') {
      summaryHtml = `
        <div class="summary-section">
          <div class="d-flex align-items-start">
            <i class="fas fa-chart-line me-3 text-info mt-1"></i>
            <div>
              <h6 class="mb-2 text-dark">Health Overview</h6>
              <p class="mb-0 text-muted lh-base">${aiData}</p>
            </div>
          </div>
        </div>`;
    } else if (typeof aiData === 'object' && aiData !== null) {
      // Handle structured AI response
      if (aiData.summary) {
        summaryHtml += `
          <div class="summary-section mb-4">
            <div class="d-flex align-items-start">
              <i class="fas fa-chart-line me-3 text-info mt-1"></i>
              <div>
                <h6 class="mb-2 text-dark">Weekly Overview</h6>
                <p class="mb-0 text-muted lh-base">${aiData.summary}</p>
              </div>
            </div>
          </div>`;
      }
      
      if (aiData.praise && Array.isArray(aiData.praise) && aiData.praise.length > 0) {
        summaryHtml += `
          <div class="summary-section mb-4">
            <div class="d-flex align-items-start">
              <i class="fas fa-thumbs-up me-3 text-success mt-1"></i>
              <div>
                <h6 class="mb-2 text-dark">Good Habits</h6>
                <ul class="list-unstyled mb-0">`;
        aiData.praise.forEach(item => {
          summaryHtml += `
                  <li class="mb-2">
                    <i class="fas fa-check-circle me-2 text-success"></i>
                    <span class="text-muted">${item}</span>
                  </li>`;
        });
        summaryHtml += '</ul></div></div>';
      }
      
      if (aiData.warnings && Array.isArray(aiData.warnings) && aiData.warnings.length > 0) {
        summaryHtml += `
          <div class="summary-section mb-4">
            <div class="d-flex align-items-start">
              <i class="fas fa-exclamation-triangle me-3 text-warning mt-1"></i>
              <div>
                <h6 class="mb-2 text-dark">Areas to Watch</h6>
                <ul class="list-unstyled mb-0">`;
        aiData.warnings.forEach(item => {
          summaryHtml += `
                  <li class="mb-2">
                    <i class="fas fa-exclamation-circle me-2 text-warning"></i>
                    <span class="text-muted">${item}</span>
                  </li>`;
        });
        summaryHtml += '</ul></div></div>';
      }
      
      if (aiData.suggestions && Array.isArray(aiData.suggestions) && aiData.suggestions.length > 0) {
        summaryHtml += `
          <div class="summary-section mb-0">
            <div class="d-flex align-items-start">
              <i class="fas fa-lightbulb me-3 text-info mt-1"></i>
              <div>
                <h6 class="mb-2 text-dark">Recommendations</h6>
                <ul class="list-unstyled mb-0">`;
        aiData.suggestions.forEach(item => {
          summaryHtml += `
                  <li class="mb-2">
                    <i class="fas fa-arrow-right me-2 text-info"></i>
                    <span class="text-muted">${item}</span>
                  </li>`;
        });
        summaryHtml += '</ul></div></div>';
      }
    }
    
    if (!summaryHtml) {
      summaryHtml = `
        <div class="alert alert-info border-0">
          <div class="d-flex align-items-center">
            <i class="fas fa-info-circle me-3 text-info"></i>
            <div>
              <strong>Getting Started</strong>
              <div class="mt-1 text-muted">No health insights available yet. Start logging your daily health data to get personalized recommendations!</div>
            </div>
          </div>
        </div>`;
    }
    
    summaryEl.innerHTML = summaryHtml;
  }
  
  // Make retry function globally available
  window.retryAIAnalysis = async function() {
    summaryEl.innerHTML = `
      <div class="loading-spinner">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        Retrying AI analysis...
      </div>`;
    
    try {
      const resp = await fetch("{% url 'core:goal_data_api' %}");
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
      }
      const data = await resp.json();
      
      if (data.ai_summary) {
        if (data.ai_summary.error) {
          showAIError(data.ai_summary.error, true);
        } else {
          showAISummary(data.ai_summary);
        }
      } else {
        showAIError("No AI summary data received", true);
      }
    } catch (error) {
      logDebug("Retry failed", error);
      showAIError("Failed to retry AI analysis. Please check your connection and try again.", true);
    }
  };

  try {
    logDebug("Fetching dashboard data...");
    
    const resp = await fetch("{% url 'core:goal_data_api' %}");
    if (!resp.ok) {
      throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
    }
    
    const data = await resp.json();
    logDebug("Dashboard data received", data);

    // Update streak and monthly stats
    document.getElementById("maxStreak").innerText = data.max_streak ?? 0;
    document.getElementById("currentStreak").innerText = data.current_streak ?? 0;
    document.getElementById("monthlyCount").innerText = data.monthly_active_count ?? 0;

    // Create GitHub-style Monthly Heatmap
    function createMonthlyHeatmap(monthlyData) {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
     
      // Set month label
      const monthsContainer = document.getElementById("heatmapMonths");
      monthsContainer.innerHTML = `<span class="month-label">${monthNames[currentMonth]} ${currentYear}</span>`;
     
      // Get month details
      const firstDay = new Date(currentYear, currentMonth, 1);
      const firstDayOfWeek = firstDay.getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
     
      const gridContainer = document.getElementById("heatmapGrid");
      gridContainer.innerHTML = '';
     
      // Day labels
      const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const labelsRow = document.createElement('div');
      labelsRow.className = 'heatmap-labels';
      dayLabels.forEach(label => {
        const labelEl = document.createElement('span');
        labelEl.textContent = label;
        labelEl.className = 'day-label';
        labelsRow.appendChild(labelEl);
      });
      gridContainer.appendChild(labelsRow);
     
      // Create weekly rows
      let currentWeek = document.createElement('div');
      currentWeek.className = 'heatmap-week';
     
      // Empty cells before month starts
      for (let i = 0; i < firstDayOfWeek; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'heatmap-day empty';
        currentWeek.appendChild(emptyCell);
      }
     
      // Days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dateStr = date.toISOString().split('T')[0];
        const dayOfWeek = (firstDayOfWeek + day - 1) % 7;
       
        // New week row
        if (dayOfWeek === 0 && day > 1) {
          gridContainer.appendChild(currentWeek);
          currentWeek = document.createElement('div');
          currentWeek.className = 'heatmap-week';
        }
       
        const cell = document.createElement('div');
        cell.className = 'heatmap-day';
       
        const activityLevel = monthlyData[dateStr] || 0;
        cell.setAttribute('data-level', activityLevel);
        cell.setAttribute('data-date', dateStr);
        cell.title = `${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}: ${activityLevel > 0 ? `Activity level ${activityLevel}` : 'No activity'}`;
       
        // Highlight today
        if (dateStr === today.toISOString().split('T')[0]) {
          cell.classList.add('today');
        }
       
        cell.textContent = day;
        currentWeek.appendChild(cell);
      }
     
      // Fill remaining cells in last week
      const remainingCells = 7 - ((firstDayOfWeek + daysInMonth) % 7);
      if (remainingCells < 7) {
        for (let i = 0; i < remainingCells; i++) {
          const emptyCell = document.createElement('div');
          emptyCell.className = 'heatmap-day empty';
          currentWeek.appendChild(emptyCell);
        }
      }
     
      gridContainer.appendChild(currentWeek);
    }

    createMonthlyHeatmap(data.monthly_data || {});

    // Chart utilities
    function hasRealData(values) {
      return values.some(v => v !== null && v !== undefined && !isNaN(v));
    }

    function createPlaceholderChart(canvasId, title) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['No Data Available'],
          datasets: [{
            label: title,
            data: [0],
            backgroundColor: '#f8f9fa',
            borderColor: '#dee2e6',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, labels: { color: '#6c757d' } },
            title: { display: true, text: title + ' - No Data', color: '#6c757d' }
          },
          scales: { x: { display: false }, y: { display: false } }
        }
      });
    }

    function createRealChart(canvasId, title, datasets, labels, chartType = 'line') {
      const ctx = document.getElementById(canvasId).getContext('2d');
      return new Chart(ctx, {
        type: chartType,
        data: { labels: labels, datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true }, title: { display: true, text: title } },
          scales: { x: { display: true }, y: { display: true, beginAtZero: chartType === 'bar' } }
        }
      });
    }

    // Prepare chart data
    const dates = data.logs.map(l => new Date(l.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    const systolic = data.logs.map(l => l.systolic_bp);
    const diastolic = data.logs.map(l => l.diastolic_bp);
    const sleep = data.logs.map(l => l.sleep_hours);
    const exercise = data.logs.map(l => l.exercise_minutes);
    const stress = data.logs.map(l => l.stress_level);

    // Create charts
    if (hasRealData(systolic) || hasRealData(diastolic)) {
      const bpDatasets = [];
      if (hasRealData(systolic)) {
        bpDatasets.push({
          label: "Systolic", data: systolic, borderColor: "rgb(255,99,132)",
          backgroundColor: "rgba(255,99,132,0.1)", tension: 0.1
        });
      }
      if (hasRealData(diastolic)) {
        bpDatasets.push({
          label: "Diastolic", data: diastolic, borderColor: "rgb(54,162,235)",
          backgroundColor: "rgba(54,162,235,0.1)", tension: 0.1
        });
      }
      createRealChart("bpChart", "Blood Pressure", bpDatasets, dates, 'line');
    } else {
      createPlaceholderChart("bpChart", "Blood Pressure");
    }

    if (hasRealData(sleep)) {
      createRealChart("sleepChart", "Sleep Hours", [{
        label: "Sleep Hours", data: sleep, backgroundColor: "rgba(75,192,192,0.6)",
        borderColor: "rgb(75,192,192)", borderWidth: 1
      }], dates, 'bar');
    } else {
      createPlaceholderChart("sleepChart", "Sleep Hours");
    }

    if (hasRealData(exercise)) {
      createRealChart("exerciseChart", "Exercise Minutes", [{
        label: "Exercise Minutes", data: exercise, backgroundColor: "rgba(255,159,64,0.6)",
        borderColor: "rgb(255,159,64)", borderWidth: 1
      }], dates, 'bar');
    } else {
      createPlaceholderChart("exerciseChart", "Exercise Minutes");
    }

    if (hasRealData(stress)) {
      createRealChart("stressChart", "Stress Level", [{
        label: "Stress Level (1-5)", data: stress, backgroundColor: "rgba(153,102,255,0.6)",
        borderColor: "rgb(153,102,255)", borderWidth: 1
      }], dates, 'bar');
    } else {
      createPlaceholderChart("stressChart", "Stress Level");
    }

    // Process AI Summary with improved error handling
    logDebug("Processing AI summary...", data.ai_summary);
    
    if (data.ai_summary) {
      if (data.ai_summary.error) {
        logDebug("AI summary has error", data.ai_summary.error);
        showAIError(data.ai_summary.error, true);
      } else {
        logDebug("Showing AI summary", data.ai_summary);
        showAISummary(data.ai_summary);
      }
    } else {
      logDebug("No AI summary in response");
      showAIError("AI analysis is currently unavailable. Please try again later.", true);
    }

  } catch (error) {
    console.error('Error loading dashboard data:', error);
    logDebug("Dashboard loading error", error);
    
    // Show error for AI summary specifically
    showAIError("Unable to load health insights. Please check your connection and try again.", true);
    
    // Show general error message
    const generalError = document.createElement('div');
    generalError.className = 'alert alert-danger mt-3';
    generalError.innerHTML = `
      <i class="fas fa-exclamation-circle me-2"></i>
      Error loading dashboard data. Please refresh the page.
    `;
    document.querySelector('.container').appendChild(generalError);
  }
});
</script>

<style>
/* Heatmap Styles */
.heatmap-container {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin: 20px 0;
}

.month-label {
  font-weight: 600;
  font-size: 16px;
  color: #24292e;
}

.heatmap-labels {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 3px;
  margin-bottom: 8px;
}

.day-label {
  font-size: 11px;
  color: #586069;
  text-align: center;
  font-weight: 400;
}

.heatmap-grid {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.heatmap-week {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 3px;
}

.heatmap-day {
  width: 14px;
  height: 14px;
  border-radius: 2px;
  cursor: pointer;
  font-size: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #586069;
  font-weight: 500;
  transition: all 0.2s ease;
}

.heatmap-day:not(.empty):hover {
  transform: scale(1.2);
  z-index: 1;
  position: relative;
}

.heatmap-day.empty {
  visibility: hidden;
}

.heatmap-day.today {
  border: 2px solid #0366d6;
  border-radius: 3px;
}

.heatmap-day[data-level="0"] { background-color: #ebedf0; color: #9ca3af; }
.heatmap-day[data-level="1"] { background-color: #9be9a8; color: #22543d; }
.heatmap-day[data-level="2"] { background-color: #40c463; color: white; }
.heatmap-day[data-level="3"] { background-color: #30a14e; color: white; }
.heatmap-day[data-level="4"] { background-color: #216e39; color: white; }

.heatmap-legend {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  margin-top: 15px;
  gap: 8px;
}

.legend-label {
  font-size: 11px;
  color: #586069;
}

.legend-squares {
  display: flex;
  gap: 3px;
}

.legend-square {
  width: 10px;
  height: 10px;
  border-radius: 2px;
}

.legend-square[data-level="0"] { background-color: #ebedf0; }
.legend-square[data-level="1"] { background-color: #9be9a8; }
.legend-square[data-level="2"] { background-color: #40c463; }
.legend-square[data-level="3"] { background-color: #30a14e; }
.legend-square[data-level="4"] { background-color: #216e39; }

/* Charts Grid */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
  margin: 30px 0;
}

.chart-container {
  position: relative;
  height: 250px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  padding: 10px;
}

/* AI Summary */
.ai-summary-content {
  line-height: 1.6;
}

.summary-section {
  margin-bottom: 20px;
}

.summary-section h6 {
  color: #495057;
  margin-bottom: 8px;
  font-weight: 600;
}

.summary-section p {
  color: #6c757d;
  margin-bottom: 8px;
}

.loading-spinner {
  display: flex;
  align-items: center;
  color: #6c757d;
  padding: 20px 0;
}

.alert {
  border-radius: 8px;
  border: none;
  margin: 0;
}

.alert .d-flex {
  align-items: flex-start;
}

.lh-base {
  line-height: 1.5 !important;
}

/* Responsive */
@media (max-width: 768px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
 
  .chart-container {
    height: 200px;
  }
  
  .summary-section .d-flex {
    flex-direction: column;
  }
  
  .summary-section .d-flex i {
    margin-bottom: 8px;
  }
}

/* Debug styles */
#debugInfo {
  background: #f8f9fa;
  border-radius: 4px;
  padding: 10px;
  max-height: 300px;
  overflow-y: auto;
}

#debugContent pre {
  background: #fff;
  border: 1px solid #dee2e6;
  border-radius: 3px;
  padding: 8px;
  margin: 5px 0;
  white-space: pre-wrap;
  word-wrap: break-word;
}
</style>
{% endblock %}